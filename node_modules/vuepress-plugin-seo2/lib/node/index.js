import{colors as S,fs as D}from"@vuepress/utils";import{Logger as B,entries as F,isString as v,isAbsoluteUrl as x,isUrl as L,isLinkHttp as J,removeEndingSlash as I,removeLeadingSlash as M,stripTags as R,getPageText as W,getAuthor as E,isArray as q,getDateInfo as T,isFunction as z,startsWith as V,checkVersion as K}from"vuepress-shared/node";const O="vuepress-plugin-seo2",c=new B(O),_=({lang:t,path:e,pathLocale:a},{pages:n,siteData:r})=>F(r.locales).map(([i,{lang:o}])=>({path:`${i}${e.replace(a,"")}`,lang:o})).filter(i=>v(i.lang)&&i.lang!==t&&n.some(({path:o})=>o===i.path)),U=({frontmatter:t},{options:{base:e}},{hostname:a})=>{const{banner:n,cover:r}=t;if(n){if(x(n))return u(a,e,n);if(L(n))return n}if(r){if(x(r))return u(a,e,r);if(L(r))return r}return null},G=({content:t},{options:{base:e}},{hostname:a})=>{const n=/!\[.*?\]\((.*?)\)/giu.exec(t);return n?n.map(([,r])=>x(r)?u(a,e,r):L(r)?r:null).filter(r=>r!==null):[]},u=(t,e,a)=>`${J(t)?I(t):`https://${I(t)}`}${e}${M(a)}`,N=(t,e,a="",n="")=>{e in t&&(c.error(`"${S.magenta(e)}" is ${S.red("removed")}${n?`, please use ${S.magenta(n)} instead.`:" and no longer supported"}${a?`
${a}`:""}`),n||delete t[e])},Q=t=>{N(t,"seo","","ogp"),N(t,"customMeta","","customHead")},X=(t,e=!0)=>{if(!t.frontmatter.description&&e){if(t.data.excerpt)t.frontmatter.description=R(t.data.excerpt).replace(/(?:\r?\n)+/g," ").replace(/ +/g," ").trim();else{const a=W(t);t.frontmatter.description=a.length>180?`${a.slice(0,177)}...`:a}t.data.autoDesc=!0}},Y=(t,e,a)=>{const{isArticle:n=b=>!!(b.filePathRelative&&!b.frontmatter.home),author:r}=e,{options:{base:i},siteData:o}=a,{frontmatter:{author:s,time:m,date:d=m,tag:g,tags:h=g},data:{git:f={}}}=t,w=o.locales[t.pathLocale]?.title||o.title||o.locales["/"]?.title||"",$=s===!1?[]:E(s||r),l=f.updatedTime?new Date(f.updatedTime).toISOString():null,p=q(h)?h:v(g)?[g]:[],y=t.title,C=U(t,a,e),H=G(t,a,e),j=_(t,a),A=T(d)?.value?.toISOString(),k=C||H[0]||e.fallBackImage||"";return{"og:url":u(e.hostname,i,t.path),"og:site_name":w,"og:title":y,"og:description":t.frontmatter.description||"","og:type":n(t)?"article":"website","og:image":k,"og:locale":t.lang,"og:locale:alternate":j.map(({lang:b})=>b),...l?{"og:updated_time":l}:{},...e.restrictions?{"og:restrictions:age":e.restrictions}:{},...e.twitterID?{"twitter:creator":e.twitterID}:{},...k?{"twitter:card":"summary_large_image","twitter:image:alt":y}:{},"article:author":$[0]?.name,"article:tag":p,...A?{"article:published_time":A}:{},...l?{"article:modified_time":l}:{}}},Z=(t,e,a)=>{const{isArticle:n=p=>!!(p.filePathRelative&&!p.frontmatter.home),author:r}=e,{title:i,frontmatter:{author:o,description:s,time:m,date:d=m},data:{git:g={}}}=t,h=o===!1?[]:E(o||r),f=T(d)?.value?.toISOString(),w=g.updatedTime?new Date(g.updatedTime).toISOString():null,$=U(t,a,e),l=G(t,a,e);return n(t)?{"@context":"https://schema.org","@type":"Article",headline:i,image:l.length?l:[$||e.fallBackImage||""],datePublished:f,dateModified:w,author:h.map(p=>({"@type":"Person",...p}))}:{"@context":"https://schema.org","@type":"WebPage",name:i,...s?{description:s}:{}}},tt=(t,e)=>z(e.canonical)?e.canonical(t):v(e.canonical)?`${I(e.canonical)}${t.path}`:null,et=(t,{hostname:e},a)=>_(t,a).map(({lang:n,path:r})=>({lang:n,path:u(e,a.options.base,r)})),P=(t,{name:e,content:a,attribute:n=["article:","og:"].some(r=>V(e,r))?"property":"name"})=>{a&&t.push(["meta",{[n]:e,content:a}])},at=(t,e)=>{for(const a in e)switch(a){case"article:tag":e["article:tag"].forEach(n=>P(t,{name:"article:tag",content:n}));break;case"og:locale:alternate":e["og:locale:alternate"].forEach(n=>{n!==e["og:locale"]&&P(t,{name:"og:locale:alternate",content:n})});break;default:e[a]&&P(t,{name:a,content:e[a]})}},nt=(t,e)=>{t.push(["script",{type:"application/ld+json"},JSON.stringify(e)])},rt=(t,e)=>{e&&t.push(["link",{rel:"canonical",href:e}])},ot=(t,e)=>{e.forEach(({lang:a,path:n})=>{t.push(["link",{rel:"alternate",hreflang:a.toLowerCase(),href:n}])})},it=(t,e)=>{t.pages.forEach(a=>{const n=a.frontmatter.head||[],r=tt(a,e),i=et(a,e,t);if(rt(n,r),ot(n,i),a.frontmatter.seo!==!1){const o=Y(a,e,t),s=Z(a,e,t),m=e.ogp?e.ogp(o,a,t):o,d=e.jsonLd?e.jsonLd(s,a,t):s;at(n,m),nt(n,d),e.customHead&&e.customHead(n,a,t)}a.frontmatter.head=n})},st=async t=>{c.load("Generating robots.txt");const e=t.public("robots.txt");let a=D.existsSync(e)?await D.readFile(e,{encoding:"utf8"}):"";a&&!a.includes("User-agent")?(c.error(),c.update("robots.txt seems invalid!")):(a+=`
User-agent:*
Disallow:
`,await D.writeFile(t.dest("robots.txt"),a,{flag:"w"}),c.succeed())},lt=(t,e=!0)=>a=>{e&&Q(t),K(a,O,"2.0.0-rc.0"),a.env.isDebug&&c.info("Options:",t);const n={name:O};return t.hostname?{...n,extendsPage:r=>{r.frontmatter.seo!==!1&&X(r,t.autoDescription!==!1)},onInitialized:r=>{it(r,t)},onGenerated:r=>st(r.dir)}:(c.error(`Option ${S.magenta("hostname")} is required!`),n)};export{lt as seoPlugin};
//# sourceMappingURL=index.js.map
