{"version":3,"file":"index.js","sources":["../../src/node/utils.ts","../../src/node/compact/utils.ts","../../src/node/compact/convert.ts","../../src/node/generateSitemap.ts","../../src/node/plugin.ts"],"sourcesContent":["import { getDirname, path } from \"@vuepress/utils\";\nimport { Logger, ensureEndingSlash } from \"vuepress-shared/node\";\n\nconst __dirname = getDirname(import.meta.url);\n\nexport const TEMPLATE_FOLDER = ensureEndingSlash(\n  path.resolve(__dirname, \"../../templates\"),\n);\n\nexport const PLUGIN_NAME = \"vuepress-plugin-sitemap2\";\n\nexport const logger = new Logger(PLUGIN_NAME);\n","import { colors } from \"@vuepress/utils\";\n\nimport { logger } from \"../utils.js\";\n\nexport interface DeprecatedLoggerOptions {\n  options: Record<string, unknown>;\n  deprecatedOption: string;\n  newOption: string;\n  msg?: string;\n  scope?: string;\n}\n\nexport const deprecatedLogger = ({\n  options,\n  deprecatedOption,\n  newOption,\n  msg = \"\",\n  scope = \"\",\n}: DeprecatedLoggerOptions): void => {\n  if (deprecatedOption in options) {\n    logger.warn(\n      `${colors.magenta(deprecatedOption)} is ${colors.yellow(\"deprecated\")}${\n        scope ? ` in ${scope}` : \"\"\n      }, please use \"${colors.magenta(newOption)}\" instead.${\n        msg ? `\\n${msg}` : \"\"\n      }`,\n    );\n\n    if (newOption.includes(\".\")) {\n      const keys = newOption.split(\".\");\n      let temp = options;\n\n      keys.forEach((key, index) => {\n        if (index !== keys.length - 1) {\n          // ensure level exists\n          temp[key] = temp[key] || {};\n\n          temp = temp[key] as Record<string, unknown>;\n        } else {\n          temp[key] = options[deprecatedOption];\n        }\n      });\n    } else {\n      options[newOption] = options[deprecatedOption];\n    }\n\n    delete options[deprecatedOption];\n  }\n};\n","import { deprecatedLogger } from \"./utils.js\";\nimport type { SitemapOptions } from \"../options.js\";\n\n/** @deprecated */\nexport const convertOptions = (\n  options: SitemapOptions & Record<string, unknown>,\n): void => {\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"urls\",\n    newOption: \"extraUrls\",\n  });\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"exclude\",\n    newOption: \"excludeUrls\",\n  });\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"outFile\",\n    newOption: \"sitemapFilename\",\n  });\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"dateFormatter\",\n    newOption: \"modifyTimeGetter\",\n  });\n};\n","import type { App, Page } from \"@vuepress/core\";\nimport type { GitData } from \"@vuepress/plugin-git\";\nimport { colors, fs } from \"@vuepress/utils\";\nimport { SitemapStream } from \"sitemap\";\nimport {\n  isLinkHttp,\n  removeEndingSlash,\n  removeLeadingSlash,\n} from \"vuepress-shared/node\";\n\nimport type { ModifyTimeGetter, SitemapOptions } from \"./options.js\";\nimport type {\n  SitemapImageOption,\n  SitemapLinkOption,\n  SitemapNewsOption,\n  SitemapPluginFrontmatter,\n  SitemapVideoOption,\n} from \"./typings/index.js\";\nimport { TEMPLATE_FOLDER, logger } from \"./utils.js\";\n\ninterface SitemapPageInfo {\n  lastmod?: string;\n  changefreq?: string;\n  priority?: number;\n  img?: SitemapImageOption[];\n  video?: SitemapVideoOption[];\n  links?: SitemapLinkOption[];\n  news?: SitemapNewsOption[];\n}\n\nconst reportedLocales: string[] = [];\n\nconst stripLocalePrefix = ({\n  path,\n  pathLocale,\n}: Page): {\n  /** path of root locale */\n  defaultPath: string;\n  /** Locale path prefix of the page */\n  pathLocale: string;\n} => ({\n  defaultPath: path.replace(pathLocale, \"/\"),\n  pathLocale: pathLocale,\n});\n\nconst generatePageMap = (\n  app: App,\n  options: SitemapOptions,\n): Map<string, SitemapPageInfo> => {\n  const {\n    changefreq = \"daily\",\n    excludeUrls = [\"/404.html\"],\n    modifyTimeGetter = <ModifyTimeGetter>(\n      ((page: Page<{ git: GitData }>): string =>\n        page.data.git?.updatedTime\n          ? new Date(page.data.git.updatedTime).toISOString()\n          : \"\")\n    ),\n  } = options;\n\n  const {\n    options: { base, locales },\n    pages,\n  } = app;\n\n  const pageLocalesMap = pages.reduce(\n    (map, page) => {\n      const { defaultPath, pathLocale } = stripLocalePrefix(page);\n      const pathLocales = map.get(defaultPath) || [];\n\n      pathLocales.push(pathLocale);\n\n      return map.set(defaultPath, pathLocales);\n    },\n    // a map with keys of defaultPath and string[] value with pathLocales\n    new Map<string, string[]>(),\n  );\n\n  const pagesMap = new Map<string, SitemapPageInfo>();\n\n  pages.forEach(\n    (page: Page<Record<never, never>, SitemapPluginFrontmatter>) => {\n      const frontmatterOptions = page.frontmatter.sitemap;\n\n      if (frontmatterOptions === false) return;\n\n      const metaRobotTags = (page.frontmatter.head || []).find(\n        (head) => head[1][\"name\"] === \"robots\",\n      );\n\n      if (\n        // meta tags do not allow index\n        (<string>metaRobotTags?.[1][\"content\"] || \"\")\n          .split(/,/u)\n          .map((content) => content.trim())\n          .includes(\"noindex\") ||\n        // exclude in plugin options\n        excludeUrls.includes(page.path)\n      )\n        return;\n\n      const lastModifyTime = modifyTimeGetter(page, app);\n      const { defaultPath } = stripLocalePrefix(page);\n      const relatedLocales = pageLocalesMap.get(defaultPath) || [];\n\n      let links: SitemapLinkOption[] = [];\n\n      if (relatedLocales.length > 1) {\n        // warnings for missing `locale[path].lang` in debug mode\n        if (app.env.isDebug)\n          relatedLocales.forEach((localePrefix) => {\n            if (\n              !locales[localePrefix].lang &&\n              !reportedLocales.includes(localePrefix)\n            ) {\n              logger.warn(`\"lang\" option for ${localePrefix} is missing`);\n              reportedLocales.push(localePrefix);\n            }\n          });\n\n        links = relatedLocales.map((localePrefix) => ({\n          lang: locales[localePrefix]?.lang || \"en\",\n          url: `${base}${removeLeadingSlash(\n            defaultPath.replace(/^\\//u, localePrefix),\n          )}`,\n        }));\n      }\n\n      const sitemapInfo: SitemapPageInfo = {\n        ...(changefreq ? { changefreq } : {}),\n        links,\n        ...(lastModifyTime ? { lastmod: lastModifyTime } : {}),\n        ...frontmatterOptions,\n      };\n\n      // log sitemap info in debug mode\n      if (app.env.isDebug)\n        logger.info(\n          `sitemap option for ${page.path}: ${JSON.stringify(\n            sitemapInfo,\n            null,\n            2,\n          )}`,\n        );\n\n      pagesMap.set(page.path, sitemapInfo);\n    },\n  );\n\n  return pagesMap;\n};\n\nexport const generateSiteMap = async (\n  app: App,\n  options: SitemapOptions,\n): Promise<void> => {\n  const { extraUrls = [], xmlNameSpace: xmlns } = options;\n  const hostname = isLinkHttp(options.hostname)\n    ? removeEndingSlash(options.hostname)\n    : `https://${removeEndingSlash(options.hostname)}`;\n  const sitemapFilename = options.sitemapFilename\n    ? removeLeadingSlash(options.sitemapFilename)\n    : \"sitemap.xml\";\n  const sitemapXSLFilename = options.sitemapXSLFilename\n    ? removeLeadingSlash(options.sitemapXSLFilename)\n    : \"sitemap.xsl\";\n  const sitemapXSLTemplate =\n    options.sitemapXSLTemplate ?? `${TEMPLATE_FOLDER}sitemap.xsl`;\n\n  const {\n    dir,\n    options: { base },\n  } = app;\n\n  logger.load(`Generating sitemap to ${colors.cyan(`/${sitemapFilename}`)}`);\n\n  await new Promise<void>((resolve) => {\n    const sitemap = new SitemapStream({\n      hostname,\n      ...(xmlns ? { xmlns } : {}),\n    });\n    const pagesMap = generatePageMap(app, options);\n    const sitemapXMLPath = dir.dest(sitemapFilename);\n    const sitemapXSLPath = dir.dest(sitemapXSLFilename);\n    const writeStream = fs.createWriteStream(sitemapXMLPath);\n\n    sitemap.pipe(writeStream);\n\n    pagesMap.forEach((page, path) =>\n      sitemap.write({\n        url: `${base}${removeLeadingSlash(path)}`,\n        ...page,\n      }),\n    );\n\n    writeStream.on(\"finish\", () => {\n      const content = fs.readFileSync(sitemapXMLPath, {\n        encoding: \"utf-8\",\n      });\n\n      fs.writeFileSync(\n        sitemapXMLPath,\n        content.replace(\n          '<?xml version=\"1.0\" encoding=\"UTF-8\"?>',\n          `\\\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<?xml-stylesheet type=\"text/xsl\" href=\"${base}${sitemapXSLFilename}\"?>\n`,\n        ),\n      );\n\n      fs.copySync(sitemapXSLTemplate, sitemapXSLPath);\n\n      resolve();\n    });\n\n    extraUrls.forEach((item) =>\n      sitemap.write({ url: `${base}${removeLeadingSlash(item)}` }),\n    );\n    sitemap.end();\n  });\n\n  logger.succeed();\n\n  const robotTxtPath = dir.dest(\"robots.txt\");\n\n  if (fs.existsSync(robotTxtPath)) {\n    logger.load(`Appended sitemap path to ${colors.cyan(\"robots.txt\")}`);\n\n    const robotsTxt = await fs.readFile(robotTxtPath, { encoding: \"utf8\" });\n\n    const newRobotsTxtContent = `${robotsTxt.replace(\n      /^Sitemap: .*$/u,\n      \"\",\n    )}\\nSitemap: ${hostname}${base}${sitemapFilename}\\n`;\n\n    await fs.writeFile(robotTxtPath, newRobotsTxtContent, { flag: \"w\" });\n\n    logger.succeed();\n  }\n};\n","import type { PluginFunction, PluginObject } from \"@vuepress/core\";\nimport { colors } from \"@vuepress/utils\";\nimport { checkVersion } from \"vuepress-shared/node\";\n\nimport { convertOptions } from \"./compact/index.js\";\nimport { generateSiteMap } from \"./generateSitemap.js\";\nimport type { SitemapOptions } from \"./options.js\";\nimport { PLUGIN_NAME, logger } from \"./utils.js\";\n\nexport const sitemapPlugin =\n  (options: SitemapOptions, legacy = true): PluginFunction =>\n  (app) => {\n    // TODO: Remove this in v2 stable\n    if (legacy)\n      convertOptions(options as SitemapOptions & Record<string, unknown>);\n    checkVersion(app, PLUGIN_NAME, \"2.0.0-rc.0\");\n\n    if (app.env.isDebug) logger.info(\"Options:\", options);\n\n    const plugin: PluginObject = {\n      name: PLUGIN_NAME,\n    };\n\n    if (!options.hostname) {\n      logger.error(`Option ${colors.magenta(\"hostname\")} is required!`);\n\n      return plugin;\n    }\n\n    return {\n      ...plugin,\n\n      onGenerated: (app): Promise<void> => generateSiteMap(app, options),\n    };\n  };\n"],"names":["__dirname","getDirname","TEMPLATE_FOLDER","ensureEndingSlash","path","PLUGIN_NAME","logger","Logger","deprecatedLogger","options","deprecatedOption","newOption","msg","scope","colors","keys","temp","key","index","convertOptions","reportedLocales","stripLocalePrefix","pathLocale","generatePageMap","app","changefreq","excludeUrls","modifyTimeGetter","page","base","locales","pages","pageLocalesMap","map","defaultPath","pathLocales","pagesMap","frontmatterOptions","head","content","lastModifyTime","relatedLocales","links","localePrefix","removeLeadingSlash","sitemapInfo","generateSiteMap","extraUrls","xmlns","hostname","isLinkHttp","removeEndingSlash","sitemapFilename","sitemapXSLFilename","sitemapXSLTemplate","dir","resolve","sitemap","SitemapStream","sitemapXMLPath","sitemapXSLPath","writeStream","fs","item","robotTxtPath","newRobotsTxtContent","sitemapPlugin","legacy","checkVersion","plugin"],"mappings":"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"}