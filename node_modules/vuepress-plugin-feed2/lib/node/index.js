import{colors as g,fs as f,getDirname as K,path as T}from"@vuepress/utils";import{fromEntries as E,entries as $,encodeXMLContent as X,encodeCDATA as q,isArray as b,isPlainObject as D,Logger as V,isLinkHttp as O,removeEndingSlash as w,removeLeadingSlash as F,isUrl as U,isAbsoluteUrl as N,HTML_TAGS as z,SVG_TAGS as B,MATHML_TAGS as Q,isFunction as h,getPageText as W,getAuthor as C,getCategory as Y,getPageExcerpt as Z,ensureEndingSlash as tt,values as et,keys as L,compareDate as it,deepAssign as st,checkVersion as at}from"vuepress-shared/node";import{js2xml as P}from"xml-js";import{load as nt}from"cheerio";const A=e=>E($(e).map(([t,i])=>t==="_attributes"&&i?[t,E($(i).map(([s,n])=>[s,n?X(n.toString()):void 0]))]:t==="_text"?[t,X(i.toString())]:t==="_cdata"?[t,q(i)]:t==="_comment"||t==="_instruction"?[t,i]:b(i)?[t,i.map(s=>A(s))]:D(i)?[t,A(i)]:[t,X(String(i))])),v="vuepress-plugin-feed2",y=new V(v),p=(e,t="",i="")=>`${O(e)?w(e):`https://${w(e)}`}${t}${F(i)}`,rt=(e="")=>`image/${e==="jpg"?"jpeg":e==="svg"?"svg+xml":e==="jpeg"||e==="png"||e==="bmp"||e==="gif"||e==="webp"?e:""}`,I=({options:e,deprecatedOption:t,newOption:i,msg:s="",scope:n=""})=>{if(t in e){if(y.warn(`${g.magenta(t)} is ${g.yellow("deprecated")}${n?` in ${n}`:""}, please use "${g.magenta(i)}" instead.${s?`
${s}`:""}`),i.includes(".")){const a=i.split(".");let r=e;a.forEach((o,l)=>{l!==a.length-1?(r[o]=r[o]||{},r=r[o]):r[o]=e[t]})}else e[i]=e[t];delete e[t]}},ot=(e,t,i="",s="")=>{t in e&&(y.error(`"${g.magenta(t)}" is ${g.red("removed")}${s?`, please use ${g.magenta(s)} instead.`:" and no longer supported"}${i?`
${i}`:""}`),s||delete e[t])},lt=e=>{const t=e.output;D(t)&&(e.atom=t.atom?.enable??!1,e.json=t.json?.enable??!1,e.rss=t.rss?.enable??!1,e.atomOutputFilename=t.atom?.path??"atom.xml",e.jsonOutputFilename=t.json?.path??"feed.json",e.rssOutputFilename=t.rss?.path??"rss.xml"),I({options:e,deprecatedOption:"customElements",newOption:"preservedElements"}),I({options:e,deprecatedOption:"removedElements",newOption:"preservedElements"}),ot(e,"output")},j=e=>{const{name:t="Unknown",email:i,url:s}=e;return{name:t,...i?{email:i}:{},...s?{uri:s}:{}}},pt=e=>{const{name:t,scheme:i=""}=e;return{_attributes:{term:t,scheme:i}}},ct=e=>{const{channel:t,links:i}=e.options,s={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${i.atomXsl}"`},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...t.language?{"xml:lang":t.language}:{}},id:t.link,title:t.title,...t.description?{subtitle:t.description}:{},...t.author?{author:b(t.author)?t.author.map(n=>j(n)):[j(t.author)]}:{},...t.icon?{icon:t.icon}:{},...t.image?{logo:t.image}:{},...t.copyright?{rights:t.copyright}:{},updated:t.lastUpdated?t.lastUpdated.toISOString():new Date().toISOString(),generator:v,link:[{_attributes:{rel:"self",href:i.atom}}]}};return t.link&&s.feed.link.push({_attributes:{rel:"alternate",href:t.link}}),t.hub&&s.feed.link.push({_attributes:{rel:"hub",href:t.hub}}),t.image&&(s.feed.logo=t.image),t.icon&&(s.feed.icon=t.icon),t.copyright&&(s.feed.rights=t.copyright),s.feed.category=Array.from(e.categories).map(n=>({_attributes:{term:n}})),s.feed.contributor=Array.from(e.contributors).filter(n=>n.name).map(n=>j(n)),s.feed.entry=e.items.map(n=>{const a={title:{_attributes:{type:"text"},_text:n.title},id:n.guid||n.link,link:{_attributes:{href:n.link}},updated:n.lastUpdated.toISOString()};return n.summary?a.summary={_attributes:{type:"html"},_cdata:n.summary}:n.description&&(a.summary={_attributes:{type:"text"},_text:n.description}),n.content&&(a.content={_attributes:{type:"html"},_cdata:n.content}),n.author&&(a.author=n.author.filter(r=>r.name).map(r=>j(r))),n.category&&(a.category=n.category.map(r=>pt(r))),n.contributor&&(a.contributor=n.contributor.map(r=>j(r))),n.pubDate&&(a.published=n.pubDate.toISOString()),n.copyright&&(a.rights=n.copyright),a}),P(A(s),{compact:!0,ignoreComment:!0,spaces:2})},M=e=>({name:e.name,...e.url?{url:e.url}:{},...e.avatar?{avatar:e.avatar}:{}}),mt=e=>{const{channel:t,links:i}=e.options,s={version:"https://jsonfeed.org/version/1.1",title:t.title,home_page_url:t.link,feed_url:i.json};t.description&&(s.description=t.description),t.image&&(s.icon=t.image),t.icon&&(s.favicon=t.icon);const n=(b(t.author)?t.author:t.author?[t.author]:[]).filter(a=>!!a?.name);return n.length&&(s.authors=n.map(a=>M(a))),s.items=e.items.map(a=>{const r={title:a.title,url:a.link,id:a.guid||a.link,...a.description?{summary:a.description}:{},content_html:a.content};return a.image&&(r.image=a.image),a.pubDate&&(r.date_published=a.pubDate.toISOString()),a.lastUpdated&&(r.date_modified=a.lastUpdated.toISOString()),b(a.author)&&(r.authors=a.author.filter(o=>o.name).map(o=>M(o))),a.category&&(r.tags=a.category.filter(o=>o.name).map(o=>o.name)),r}),JSON.stringify(s,null,2)},ht=e=>{const{name:t,domain:i}=e;return{_text:t,...i?{_attributes:{domain:i}}:{}}},ut=e=>{const t=e.guid||e.link;return{...U(t)?{}:{_attributes:{isPermaLink:"false"}},_text:t}},gt=e=>({_attributes:{url:e.url,...e.length?{length:e.length}:{},...e.type?{type:e.type}:{}}}),dt=e=>{const{links:t,channel:i}=e.options;let s=!1;const n={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${t.rssXsl}"`},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:t.rss,rel:"self",type:"application/rss+xml"}},title:{_text:i.title},link:{_text:i.link},description:{_text:i.description},language:{_text:i.language},pubDate:{_text:i.pubDate?i.pubDate.toUTCString():new Date().toUTCString()},lastBuildDate:{_text:i.lastUpdated?i.lastUpdated.toUTCString():new Date().toUTCString()},generator:{_text:v},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return i.copyright&&(n.rss.channel.copyright={_text:i.copyright}),i.ttl&&(n.rss.channel.ttl={_text:i.ttl.toString()}),i.image&&(n.rss.channel.image={title:{_text:i.title},url:{_text:i.image},link:{_text:i.link}}),n.rss.channel.category=Array.from(e.categories).map(a=>({_text:a})),n.rss.channel.item=e.items.map(a=>{const r={title:{_text:a.title},link:{_text:a.link},guid:ut(a),source:{_attributes:{url:t.rss},_text:a.title}};if(a.description&&(r.description={_text:a.description}),a.author){const o=a.author.find(l=>l.email&&l.name);o&&(r.author={_text:`${o.email} (${o.name})`})}return a.category&&(r.category=a.category.filter(o=>o.name).map(o=>ht(o))),a.comments&&(r.comments={_text:a.link}),a.pubDate&&(r.pubDate={_text:a.pubDate.toUTCString()}),a.content&&(s=!0,r["content:encoded"]={_cdata:a.content}),a.enclosure&&(r.enclosure=gt(a.enclosure)),r}),s&&(n.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",n.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),P(A(n),{compact:!0,ignoreComment:!0,spaces:2})};class ft{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=i=>{this.items.push(i)},this.addCategory=i=>{this.categories.add(i)},this.addContributor=i=>{const s=i.email||i.name;s&&!this._contributorKeys.has(s)&&(this._contributorKeys.add(s),this.contributors.push(i))},this.atom=()=>ct(this),this.rss=()=>dt(this),this.json=()=>mt(this)}}const bt=["h1","h2","h3","h4","h5","h6"],R=(e,t,i)=>{if(e.type==="tag"){if(e.tagName==="img"){const{src:s}=e.attribs;if(!O(s)&&!N(s))return null}return[e.attribs.class,e.attribs.id].some(s=>["table-of-contents","toc"].includes(s))||e.tagName==="pre"?null:z.includes(e.tagName)||B.includes(e.tagName)||Q.includes(e.tagName)?(bt.includes(e.tagName)&&(delete e.attribs.id,delete e.attribs.tabindex,e.children=e.children.filter(s=>s.type!=="tag"||s.tagName!=="a"||s.attribs.class!=="header-anchor")),e.tagName==="code"&&delete e.attribs["v-pre"],e.children=G(e.children,t,i),e):e.tagName==="routerlink"||e.tagName==="vplink"?(e.tagName="a",e.attribs.href=`${w(t)}${e.attribs.to}`,e.attribs.target="blank",delete e.attribs.to,e.children=G(e.children,t,i),e):i(e.tagName)?e:null}return e},G=(e,t,i)=>b(e)?e.map(s=>R(s,t,i)).filter(s=>s!==null):[],H=nt(""),yt=(e,t,i)=>{const s=e.dir.dest(t.path),n=f.existsSync(s)?f.readFileSync(s,"utf-8"):t.contentRendered;let a="";const r=H.parseHTML(n)||[];for(const o of r){const l=R(o,e.options.base,i);l&&(a+=`${H.html(l)}`)}return a};class _t{constructor(t,i,s,n){this.app=t,this.options=i,this.page=s,this.feed=n,this.base=this.app.options.base,this.frontmatter=s.frontmatter,this.getter=i.getter||{},this.pageOptions=this.frontmatter.feed||{},this.isPreservedElement=a=>{const{preservedElements:r}=this.options;return b(r)?r.some(o=>o instanceof RegExp?o.test(a):o===a):h(r)?r(a):!1}}get title(){return h(this.getter.title)?this.getter.title(this.page):this.pageOptions.title||this.page.title}get link(){return h(this.getter.link)?this.getter.link(this.page):p(this.options.hostname,this.base,this.page.path)}get description(){if(h(this.getter.description))return this.getter.description(this.page);if(this.pageOptions.description)return this.pageOptions.description;if(this.frontmatter.description)return this.frontmatter.description;const t=W(this.page);return t.length>180?`${t.slice(0,177)}...`:t}get author(){return h(this.getter.author)?this.getter.author(this.page):b(this.pageOptions.author)?this.pageOptions.author:D(this.pageOptions.author)?[this.pageOptions.author]:this.frontmatter.author===!1?[]:this.frontmatter.author?C(this.frontmatter.author):this.options.channel?.author?C(this.options.channel?.author):[]}get category(){if(h(this.getter.category))return this.getter.category(this.page);if(b(this.pageOptions.category))return this.pageOptions.category;if(D(this.pageOptions.category))return[this.pageOptions.category];const{categories:t,category:i=t}=this.frontmatter;return Y(i).map(s=>({name:s}))}get enclosure(){return h(this.getter.enclosure)?this.getter.enclosure(this.page):this.image?{url:this.image,type:rt(this.image.split(".").pop())}:null}get guid(){return this.pageOptions.guid||this.link}get pubDate(){if(h(this.getter.publishDate))return this.getter.publishDate(this.page);const{time:t,date:i=t}=this.page.frontmatter,{createdTime:s}=this.page.data.git||{};return i&&i instanceof Date?i:s?new Date(s):null}get lastUpdated(){if(h(this.getter.lastUpdateDate))return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get excerpt(){return h(this.getter.excerpt)?this.getter.excerpt(this.page):this.pageOptions.summary?this.pageOptions.summary:Z(this.app,this.page,{isCustomElement:this.isPreservedElement})}get content(){return h(this.getter.content)?this.getter.content(this.page):this.pageOptions.content?this.pageOptions.content:yt(this.app,this.page,this.isPreservedElement)}get image(){if(h(this.getter.image))return this.getter.image(this.page);const{banner:t,cover:i}=this.frontmatter;if(t){if(N(t))return p(this.options.hostname,this.app.options.base,t);if(U(t))return t}if(i){if(N(i))return p(this.options.hostname,this.app.options.base,i);if(U(i))return i}const s=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(s){if(N(s[1]))return p(this.options.hostname,this.app.options.base,s[1]);if(U(s[1]))return s[1]}return null}get contributor(){return h(this.getter.contributor)?this.getter.contributor(this.page):b(this.pageOptions.contributor)?this.pageOptions.contributor:D(this.pageOptions.contributor)?[this.pageOptions.contributor]:this.author}get copyright(){if(h(this.getter.copyright))return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t?.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:i,content:s,contributor:n,copyright:a,description:r,enclosure:o,excerpt:l,guid:c,image:m,lastUpdated:u,link:d,pubDate:_,title:x}=this;return!x&&!r?null:(i&&i.forEach(S=>this.feed.addCategory(S.name)),n&&n.forEach(S=>this.feed.addContributor(S)),{title:x,link:d,guid:c,lastUpdated:u,content:s,author:t,contributor:n,...r?{description:r}:{},...l?{summary:l}:{},...i?{category:i}:{},...o?{enclosure:o}:{},..._?{pubDate:_}:{},...m?{image:m}:{},...a?{copyright:a}:{}})}}const Ot=K(import.meta.url),J=tt(T.resolve(Ot,"../../templates")),xt=e=>e.hostname?(e.hostname=O(e.hostname)?w(e.hostname):`https://${w(e.hostname)}`,!0):!1,$t=e=>e.locales&&et(e.locales).some(({atom:t,json:i,rss:s})=>t||i||s)||!!(e.atom||e.json||e.rss),Ft=({siteData:e},t)=>E(L({"/":{},...e.locales}).map(i=>[i,{filter:({frontmatter:s,filePathRelative:n})=>!(s.home||!n||s.article===!1||s.feed===!1),sorter:(s,n)=>it(s.data.git?.createdTime?new Date(s.data.git?.createdTime):s.frontmatter.date,n.data.git?.createdTime?new Date(n.data.git?.createdTime):n.frontmatter.date),...t,...t.locales?.[i],hostname:t.hostname}])),kt=(e,t,i="")=>{const{base:s}=e.options,{title:n,description:a,lang:r,locales:o}=e.siteData,{channel:l={},hostname:c,icon:m,image:u}=t,d=b(t.channel?.author)?t.channel?.author[0]?.name:t.channel?.author?.name,_={title:o[i]?.title||n||o["/"]?.title||"",link:p(c,s,i),description:o[i]?.description||a||o["/"]?.description||"",language:o[i]?.lang||r,copyright:d?`Copyright by ${d}`:"",pubDate:new Date,lastUpdated:new Date,...m?{icon:O(m)?m:p(c,s,m)}:{},...u?{image:O(u)?u:p(c,s,u)}:{}};return st(_,l,{...l.icon?{icon:O(l.icon)?l.icon:p(c,s,l.icon)}:{},...l.image?{image:O(l.image)?l.image:p(c,s,l.image)}:{}})},k=(e,t="/")=>({atomOutputFilename:`${F(t)}${e.atomOutputFilename||"atom.xml"}`,atomXslFilename:`${F(t)}${e.atomXslFilename||"atom.xsl"}`,atomXslTemplate:e.atomXslTemplate||`${J}atom.xsl`,jsonOutputFilename:`${F(t)}${e.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${F(t)}${e.rssOutputFilename||"rss.xml"}`,rssXslFilename:`${F(t)}${e.rssXslFilename||"rss.xsl"}`,rssXslTemplate:e.rssXslTemplate||`${J}rss.xsl`}),St=({options:{base:e}},t,i)=>{const{hostname:s}=t,{atomOutputFilename:n,atomXslFilename:a,jsonOutputFilename:r,rssOutputFilename:o,rssXslFilename:l}=k(t,i);return{localePath:i,atom:p(s,e,n),atomXsl:p(s,e,a),json:p(s,e,r),rss:p(s,e,o),rssXsl:p(s,e,l)}};class Dt{constructor(t,i){this.app=t,this.options=i,this.feedMap=E($(i).map(([s,n])=>[s,new ft({channel:kt(t,n,s),links:St(t,n,s)})]))}addPages(t){const i=this.feedMap[t],s=this.options[t],{count:n=100,filter:a,sorter:r}=s,o=this.app.pages.filter(c=>c.pathLocale===t).filter(a).sort(r).slice(0,n);let l=0;for(const c of o){const m=new _t(this.app,s,c,i).getFeedItem();m&&(i.addItem(m),l+=1)}y.succeed(`added ${g.cyan(`${l} page${l>1?"s":""}`)} as feed item${l>1?"s":""} in route ${g.cyan(t)}`)}async generateFeed(){const{dest:t}=this.app.dir;await Promise.all([...$(this.options).map(async([i,s])=>{if(s.atom||s.json||s.rss){const n=this.feedMap[i],{atomOutputFilename:a,jsonOutputFilename:r,rssOutputFilename:o}=k(s,i);this.addPages(i),s.atom&&(await f.ensureDir(T.dirname(t(a))),await f.outputFile(t(a),n.atom()),y.succeed(`Atom feed file generated and saved to ${g.cyan(`/${a}`)}`)),s.json&&(await f.ensureDir(T.dirname(t(r))),await f.outputFile(t(r),n.json()),y.succeed(`JSON feed file generated and saved to ${g.cyan(`/${r}`)}`)),s.rss&&(await f.ensureDir(T.dirname(t(o))),await f.outputFile(t(o),n.rss()),y.succeed(`RSS feed file generated and saved to ${g.cyan(`/${o}`)}`))}}),$(this.options).filter(([,{atom:i}])=>i).map(([i,s])=>{const{atomXslTemplate:n,atomXslFilename:a}=k(s,i);return f.copyFile(n,t(a))}),$(this.options).filter(([,{rss:i}])=>i).map(([i,s])=>{const{rssXslFilename:n,rssXslTemplate:a}=k(s,i);return f.copyFile(a,t(n))})])}}const wt=(e,t)=>{const{base:i}=e.options,{siteData:s}=e,n=L(t);if(n.length===1){const{atomOutputFilename:a,jsonOutputFilename:r,rssOutputFilename:o}=k(t["/"]),{atom:l,json:c,rss:m,hostname:u}=t["/"],d=(_,x,S)=>["link",{rel:"alternate",type:S,href:p(u,i,x),title:`${s.title||s.locales["/"]?.title||""} ${_} Feed`}];s.head??=[],l&&s.head.push(d("Atom",a,"application/atom+xml")),c&&s.head.push(d("JSON",r,"application/json")),m&&s.head.push(d("RSS",o,"application/rss+xml"))}else e.pages.forEach(a=>{const{pathLocale:r}=a,o=t[r];if(n.includes(r)){const{atomOutputFilename:l,jsonOutputFilename:c,rssOutputFilename:m}=k(o,r),u=(d,_,x)=>["link",{rel:"alternate",type:x,href:p(o.hostname,i,_),title:`${s.locales[r]?.title||s.title||s.locales["/"]?.title||""} ${d} Feed`}];a.frontmatter.head??=[],o.atom&&a.frontmatter.head.push(u("Atom",l,"application/atom+xml")),o.json&&a.frontmatter.head.push(u("JSON",c,"application/json")),o.rss&&a.frontmatter.head.push(u("RSS",m,"application/rss+xml"))}})},vt=(e,t=!0)=>i=>{t&&lt(e),at(i,v,"2.0.0-rc.0"),i.env.isDebug&&y.info("Options:",e);const s={name:v};if(!xt(e))return y.error(`Option ${g.magenta("hostname")} is required!`),s;if(!$t(e))return y.info("No requested output, the plugin won’t start!"),s;const n=Ft(i,e);return{...s,onInitialized:a=>wt(a,n),onGenerated:a=>new Dt(a,n).generateFeed()}};export{vt as feedPlugin};
//# sourceMappingURL=index.js.map
